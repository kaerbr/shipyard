name: üö¢ Shipyard Main Builder

on:
  push:
    branches: [main]
    paths: ["images/**"]

jobs:
  # JOB 1: Herausfinden, was sich ge√§ndert hat
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_changes: ${{ steps.set-matrix.outputs.has_changes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      # Diese Action ist Gold wert: Sie listet ge√§nderte Dateien auf
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v47
        with:
          files: images/**
          dir_names: true # Gib mir Ordnernamen, keine Dateinamen
          dir_names_max_depth: 2 # Nur "images/nginx", nicht tiefer
          json: true # Ausgabe direkt als JSON f√ºr die Matrix
          quotepath: false

      - name: Set matrix
        id: set-matrix
        env:
          # Wir laden den Output in eine Environment-Variable.
          # Das verhindert das Escaping-Problem (Backslashes)!
          ALL_CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
        run: |
          CHANGED_DIRS='${{ steps.changed-files.outputs.all_changed_files }}'
          echo "changed dirs: $CHANGED_DIRS"
          echo "changed dirs: $ALL_CHANGED_FILES"

          if [ "$ALL_CHANGED_FILES" == "[]" ] || [ -z "$ALL_CHANGED_FILES" ]; then
            echo "Keine relevanten √Ñnderungen gefunden."        
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            CLEAN_MATRIX=$(echo $ALL_CHANGED_FILES | jq -c 'map(split("/") | select(length == 3) | {name: .[1], variant: .[2], path: ("./" + join("/"))})')

            echo "Gefundene √Ñnderungen in: $CLEAN_MATRIX"
            echo "matrix=$CLEAN_MATRIX" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

  # JOB 2: Dynamisch bauen (ruft deinen Base-Workflow auf)
  build-images:
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    strategy:
      fail-fast: false # Wenn ein Image fehlschl√§gt, bauen die anderen trotzdem weiter
      matrix:
        # HIER passiert die Magie: Die Liste der Images kommt aus Job 1
        image: ${{ fromJson(needs.detect-changes.outputs.matrix) }}

    # Ruft deinen bestehenden Base-Workflow auf
    uses: ./.github/workflows/_base.yaml
    permissions:
      packages: write
      attestations: write
      id-token: write
    with:
      image_name: ${{ matrix.image }}
      context_path: ./images/${{ matrix.image }}
